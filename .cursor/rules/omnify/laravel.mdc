---
description: "Laravel backend development rules - security, performance, patterns"
globs: ["app/**"]
alwaysApply: false
---

# Laravel Rules

> **Documentation:** `.claude/guides/laravel/`
> **Specific Rules:** See also `laravel-controller.mdc`, `laravel-resource.mdc`, `laravel-request.mdc`, `laravel-testing.mdc`

## Critical Rules

1. **Thin Controller** - Validate → Delegate → Respond (see `laravel-controller.mdc`)
2. **Schema-First** - Use Omnify schemas, don't create migrations manually
3. **Security** - Always use `$request->validated()`, never `$request->all()`
4. **Performance** - Use `with()` for relations, `paginate()` for lists
5. **Dates** - Store UTC, return `->toISOString()`
6. **Testing** - Write 正常系 + 異常系 tests (see `laravel-testing.mdc`)
7. **Imports** - Always `use` and short class names, never FQCN inline

## File-Specific Rules

| File Type  | Rule File               | Key Focus                    |
| ---------- | ----------------------- | ---------------------------- |
| Controller | `laravel-controller.mdc` | Thin, Query Builder, OpenAPI |
| Resource   | `laravel-resource.mdc`   | Schema matches output        |
| Request    | `laravel-request.mdc`    | Schema matches validation    |
| Test       | `laravel-testing.mdc`    | 正常系 + 異常系 coverage     |

## Security Checklist

- [ ] `$fillable` defined in Model
- [ ] `$hidden` for sensitive fields
- [ ] `$request->validated()` not `$request->all()`
- [ ] No raw SQL with user input
- [ ] `with()` for eager loading
- [ ] `whenLoaded()` in Resources
- [ ] `paginate()` for list endpoints

## When to Use What

| Scenario         | Solution           |
| ---------------- | ------------------ |
| Simple CRUD      | Controller + Model |
| Multi-step logic | Service            |
| Reusable action  | Action class       |
| Async task       | Job                |

## Pre-Edit Checklist

**BEFORE editing any file, MUST:**

1. **Read the file first** - Check existing imports, patterns, style
2. **Check imports** - Add `use` if class not imported
3. **Follow existing style** - Match indentation, naming, patterns
4. **Never use FQCN inline** - Always import first

## Imports Rule

```php
// ❌ WRONG: Inline FQCN
public function store(): \Illuminate\Http\JsonResponse

// ✅ CORRECT: Import and use short name
use Illuminate\Http\JsonResponse;
public function store(): JsonResponse
```

## Don't Over-Engineer

| ❌ DON'T                             | ✅ DO                      |
| ----------------------------------- | ------------------------- |
| Add workaround to hide bugs         | Fix root cause or report  |
| Repository for simple CRUD          | Use Eloquent directly     |
| Service that just wraps Model       | Controller + Model        |
| Interface with 1 implementation     | Concrete class            |
| Manual 404 check with route binding | Trust framework           |
| "Improve" unrelated code            | Change only what's needed |
| Build for future "just in case"     | YAGNI - build when needed |

**Full examples:** `.claude/guides/laravel/architecture.md`
