# =============================================================================
# Dev Script for Windows (PowerShell) - Omnify Tunnel Version
# TunnelçµŒç”±ã§localhostã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹
# =============================================================================

$ErrorActionPreference = "Stop"

# =============================================================================
# Tunnel Serverè¨­å®š
# =============================================================================
$TUNNEL_SERVER = "dev.omnify.jp"
$TUNNEL_PORT = 7000
$FRP_TOKEN = "65565cab2397330948c3374416a829dc1d0c25ad25055dd8d712b6d6555c9f36"

# =============================================================================
# é–‹ç™ºè€…åã‚’å–å¾—/ä¿å­˜ã™ã‚‹é–¢æ•°
# =============================================================================
function Get-DevName {
    $configFile = ".omnify-dev"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    if (Test-Path $configFile) {
        $savedName = (Get-Content $configFile -Raw).Trim()
        if ($savedName) {
            return $savedName
        }
    }
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
    Write-Host ""
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    Write-Host "ğŸ”‘ Developer name required" -ForegroundColor Yellow
    Write-Host "   This will be saved to .omnify-dev"
    Write-Host "   Example: satoshi, tanaka, yamada"
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    $devName = Read-Host "   Enter your dev name"
    
    # å…¥åŠ›æ¤œè¨¼
    if ([string]::IsNullOrWhiteSpace($devName)) {
        Write-Host "âŒ Dev name cannot be empty" -ForegroundColor Red
        exit 1
    }
    
    # å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    $devName = $devName.ToLower().Replace(" ", "")
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    $devName | Set-Content $configFile -NoNewline
    Write-Host "   âœ… Saved to .omnify-dev" -ForegroundColor Green
    Write-Host ""
    
    return $devName
}

# =============================================================================
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—/ä¿å­˜ã™ã‚‹é–¢æ•°
# =============================================================================
function Get-ProjectName {
    $envFile = ".env"
    
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    if (Test-Path $envFile) {
        $content = Get-Content $envFile -Raw
        if ($content -match "OMNIFY_PROJECT_NAME=(.+)") {
            $savedName = $matches[1].Trim().Trim('"').Trim("'")
            if ($savedName) {
                return $savedName
            }
        }
    }
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ•ã‚©ãƒ«ãƒ€å
    $defaultName = Split-Path -Leaf (Get-Location)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
    Write-Host ""
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    Write-Host "ğŸ“ Project name required" -ForegroundColor Yellow
    Write-Host "   This will be saved to .env file."
    Write-Host "   Press Enter to use default: $defaultName"
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    $projectName = Read-Host "   Enter project name [$defaultName]"
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
    if ([string]::IsNullOrWhiteSpace($projectName)) {
        $projectName = $defaultName
    }
    
    # å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    $projectName = $projectName.ToLower().Replace(" ", "")
    
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    if (Test-Path $envFile) {
        $content = Get-Content $envFile -Raw
        if ($content -match "OMNIFY_PROJECT_NAME=") {
            $content = $content -replace "OMNIFY_PROJECT_NAME=.+", "OMNIFY_PROJECT_NAME=$projectName"
            $content | Set-Content $envFile -NoNewline
        } else {
            Add-Content $envFile "OMNIFY_PROJECT_NAME=$projectName"
        }
    } else {
        "OMNIFY_PROJECT_NAME=$projectName" | Set-Content $envFile
    }
    Write-Host "   âœ… Saved to .env" -ForegroundColor Green
    Write-Host ""
    
    return $projectName
}

# =============================================================================
# frpcè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆé–¢æ•°
# =============================================================================
function New-FrpcConfig {
    param(
        [string]$DevName,
        [string]$ProjectName,
        [int]$FrontendPort
    )
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    New-Item -ItemType Directory -Force -Path "./docker/frpc" | Out-Null
    
    # customDomainsã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šï¼ˆsubdomainã¯ãƒ‰ãƒƒãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ï¼‰
    $config = @"
# Omnify Tunnel Clientè¨­å®š
# Auto-generated by dev.ps1

serverAddr = "$TUNNEL_SERVER"
serverPort = $TUNNEL_PORT

auth.method = "token"
auth.token = "$FRP_TOKEN"

# Frontend
[[proxies]]
name = "$ProjectName-$DevName-frontend"
type = "http"
localIP = "host.docker.internal"
localPort = $FrontendPort
customDomains = ["$ProjectName.$DevName.dev.omnify.jp"]

# Backend API
[[proxies]]
name = "$ProjectName-$DevName-api"
type = "http"
localIP = "backend"
localPort = 8000
customDomains = ["api.$ProjectName.$DevName.dev.omnify.jp"]

# phpMyAdmin
[[proxies]]
name = "$ProjectName-$DevName-phpmyadmin"
type = "http"
localIP = "phpmyadmin"
localPort = 80
customDomains = ["pma.$ProjectName.$DevName.dev.omnify.jp"]

# Mailpit
[[proxies]]
name = "$ProjectName-$DevName-mailpit"
type = "http"
localIP = "mailpit"
localPort = 8025
customDomains = ["mail.$ProjectName.$DevName.dev.omnify.jp"]

# MinIO S3 API
[[proxies]]
name = "$ProjectName-$DevName-minio"
type = "http"
localIP = "minio"
localPort = 9000
customDomains = ["s3.$ProjectName.$DevName.dev.omnify.jp"]

# MinIO Console
[[proxies]]
name = "$ProjectName-$DevName-minio-console"
type = "http"
localIP = "minio"
localPort = 9001
customDomains = ["minio.$ProjectName.$DevName.dev.omnify.jp"]
"@
    
    $config | Set-Content "./docker/frpc/frpc.toml" -Encoding UTF8
}

# =============================================================================
# ç©ºããƒãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
# =============================================================================
function Find-AvailablePort {
    param([int]$StartPort)
    $port = $StartPort
    while (Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue) {
        $port++
    }
    return $port
}

# =============================================================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# =============================================================================

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
if (-not (Test-Path ".\backend") -or -not (Test-Path ".\frontend\package.json")) {
    Write-Host "âŒ Setup required. Run 'npm run setup' first." -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "ğŸš€ Omnify Tunnel Development Environment" -ForegroundColor Cyan
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor DarkGray
Write-Host ""

# é–‹ç™ºè€…åã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—
$DEV_NAME = Get-DevName
$PROJECT_NAME = Get-ProjectName

Write-Host "ğŸ‘¤ Developer: $DEV_NAME" -ForegroundColor White
Write-Host "ğŸ“ Project:   $PROJECT_NAME" -ForegroundColor White
Write-Host ""

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®ç©ºããƒãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
$FRONTEND_PORT = Find-AvailablePort -StartPort 3000

# =============================================================================
# Step 1: frpcè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
# =============================================================================
Write-Host "âš™ï¸  Generating frpc config..." -ForegroundColor Yellow
New-FrpcConfig -DevName $DEV_NAME -ProjectName $PROJECT_NAME -FrontendPort $FRONTEND_PORT
Write-Host "   âœ… docker/frpc/frpc.toml" -ForegroundColor Green

# =============================================================================
# Step 2: docker-compose.ymlã‚’ã‚³ãƒ”ãƒ¼
# =============================================================================
Write-Host "âš™ï¸  Generating docker-compose.yml..." -ForegroundColor Yellow
Copy-Item ".\docker\stubs\docker-compose.yml.stub" ".\docker-compose.yml" -Force
Write-Host "   âœ… docker-compose.yml" -ForegroundColor Green

# =============================================================================
# Step 3: Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
# =============================================================================
Write-Host ""
Write-Host "ğŸ³ Starting Docker services..." -ForegroundColor Yellow
docker compose up -d mysql phpmyadmin mailpit minio backend frpc

# frpcã®æ¥ç¶šã‚’å¾…ã¤
Write-Host "â³ Waiting for tunnel connection..." -ForegroundColor Yellow
Start-Sleep -Seconds 3

# =============================================================================
# Step 4: frontend .env.localã‚’æ›´æ–°
# =============================================================================
$DOMAIN = "$PROJECT_NAME.$DEV_NAME.dev.omnify.jp"
$API_DOMAIN = "api.$PROJECT_NAME.$DEV_NAME.dev.omnify.jp"

@"
NEXT_PUBLIC_API_URL=https://$API_DOMAIN
"@ | Set-Content ".\frontend\.env.local" -Encoding UTF8

# =============================================================================
# æº–å‚™å®Œäº†!
# =============================================================================
Write-Host ""
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
Write-Host "âœ… Tunnel Development Environment Ready!" -ForegroundColor Green
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
Write-Host ""
Write-Host "  ğŸŒ Frontend:    https://$DOMAIN" -ForegroundColor Cyan
Write-Host "  ğŸ”Œ API:         https://$API_DOMAIN" -ForegroundColor Cyan
Write-Host "  ğŸ—„ï¸  phpMyAdmin:  https://pma.$PROJECT_NAME.$DEV_NAME.dev.omnify.jp" -ForegroundColor Cyan
Write-Host "  ğŸ“§ Mailpit:     https://mail.$PROJECT_NAME.$DEV_NAME.dev.omnify.jp" -ForegroundColor Cyan
Write-Host "  ğŸ“¦ MinIO:       https://minio.$PROJECT_NAME.$DEV_NAME.dev.omnify.jp" -ForegroundColor Cyan
Write-Host ""
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor DarkGray
Write-Host "ğŸ–¥ï¸  Starting frontend dev server..." -ForegroundColor Yellow
Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor DarkGray
Write-Host ""

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: lockãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
Remove-Item -Path ".\frontend\.next\dev\lock" -Force -ErrorAction SilentlyContinue

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰devã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
Push-Location .\frontend
npm run dev -- -p $FRONTEND_PORT
Pop-Location
