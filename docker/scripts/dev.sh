#!/bin/bash

# =============================================================================
# Dev Script - Omnify Tunnel Version
# TunnelçµŒç”±ã§localhostã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹
# =============================================================================

set -e

# =============================================================================
# Tunnel Serverè¨­å®š
# =============================================================================
TUNNEL_SERVER="dev.omnify.jp"
TUNNEL_PORT=7000
FRP_TOKEN="65565cab2397330948c3374416a829dc1d0c25ad25055dd8d712b6d6555c9f36"

# =============================================================================
# é–‹ç™ºè€…åã‚’å–å¾—/ä¿å­˜ã™ã‚‹é–¢æ•°
# =============================================================================
get_dev_name() {
    local config_file=".omnify-dev"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    if [ -f "$config_file" ]; then
        local saved_name=$(cat "$config_file" 2>/dev/null | tr -d '\n')
        if [ -n "$saved_name" ]; then
            echo "$saved_name"
            return
        fi
    fi
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
    echo "" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "ğŸ”‘ Developer name required" >&2
    echo "   This will be saved to .omnify-dev" >&2
    echo "   Example: satoshi, tanaka, yamada" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo -n "   Enter your dev name: " >&2
    read dev_name
    
    # å…¥åŠ›æ¤œè¨¼
    if [ -z "$dev_name" ]; then
        echo "âŒ Dev name cannot be empty" >&2
        exit 1
    fi
    
    # å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    dev_name=$(echo "$dev_name" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    echo "$dev_name" > "$config_file"
    echo "   âœ… Saved to .omnify-dev" >&2
    echo "" >&2
    
    echo "$dev_name"
}

# =============================================================================
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—/ä¿å­˜ã™ã‚‹é–¢æ•°
# =============================================================================
get_project_name() {
    local env_file=".env"
    
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    if [ -f "$env_file" ]; then
        local saved_name=$(grep "^OMNIFY_PROJECT_NAME=" "$env_file" 2>/dev/null | cut -d'=' -f2 | tr -d '"' | tr -d "'")
        if [ -n "$saved_name" ]; then
            echo "$saved_name"
            return
        fi
    fi
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ•ã‚©ãƒ«ãƒ€å
    local default_name=$(basename "$(pwd)")
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
    echo "" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "ğŸ“ Project name required" >&2
    echo "   This will be saved to .env file." >&2
    echo "   Press Enter to use default: $default_name" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo -n "   Enter project name [$default_name]: " >&2
    read project_name
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
    if [ -z "$project_name" ]; then
        project_name="$default_name"
    fi
    
    # å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
    project_name=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
    
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    if [ -f "$env_file" ]; then
        # OMNIFY_PROJECT_NAMEè¡ŒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
        if grep -q "^OMNIFY_PROJECT_NAME=" "$env_file"; then
            sed -i.bak "s/^OMNIFY_PROJECT_NAME=.*/OMNIFY_PROJECT_NAME=$project_name/" "$env_file"
            rm -f "$env_file.bak"
        else
            echo "OMNIFY_PROJECT_NAME=$project_name" >> "$env_file"
        fi
    else
        echo "OMNIFY_PROJECT_NAME=$project_name" > "$env_file"
    fi
    echo "   âœ… Saved to .env" >&2
    echo "" >&2
    
    echo "$project_name"
}

# =============================================================================
# frpcè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆé–¢æ•°
# =============================================================================
generate_frpc_config() {
    local dev_name=$1
    local project_name=$2
    local frontend_port=$3
    
    mkdir -p ./docker/frpc
    
    # customDomainsã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®š
    cat > ./docker/frpc/frpc.toml << EOF
# Omnify Tunnel Clientè¨­å®š
# Auto-generated by dev.sh

serverAddr = "${TUNNEL_SERVER}"
serverPort = ${TUNNEL_PORT}

auth.method = "token"
auth.token = "${FRP_TOKEN}"

# Frontend
[[proxies]]
name = "${project_name}-${dev_name}-frontend"
type = "http"
localIP = "host.docker.internal"
localPort = ${frontend_port}
customDomains = ["${project_name}.${dev_name}.dev.omnify.jp"]

# Backend API (includes Horizon dashboard at /horizon)
[[proxies]]
name = "${project_name}-${dev_name}-api"
type = "http"
localIP = "backend"
localPort = 8000
customDomains = ["api.${project_name}.${dev_name}.dev.omnify.jp"]

# Laravel Reverb WebSocket
[[proxies]]
name = "${project_name}-${dev_name}-ws"
type = "http"
localIP = "reverb"
localPort = 8080
customDomains = ["ws.${project_name}.${dev_name}.dev.omnify.jp"]

# phpMyAdmin
[[proxies]]
name = "${project_name}-${dev_name}-phpmyadmin"
type = "http"
localIP = "phpmyadmin"
localPort = 80
customDomains = ["pma.${project_name}.${dev_name}.dev.omnify.jp"]

# Mailpit
[[proxies]]
name = "${project_name}-${dev_name}-mailpit"
type = "http"
localIP = "mailpit"
localPort = 8025
customDomains = ["mail.${project_name}.${dev_name}.dev.omnify.jp"]

# MinIO S3 API
[[proxies]]
name = "${project_name}-${dev_name}-minio"
type = "http"
localIP = "minio"
localPort = 9000
customDomains = ["s3.${project_name}.${dev_name}.dev.omnify.jp"]

# MinIO Console
[[proxies]]
name = "${project_name}-${dev_name}-minio-console"
type = "http"
localIP = "minio"
localPort = 9001
customDomains = ["minio.${project_name}.${dev_name}.dev.omnify.jp"]
EOF
}

# =============================================================================
# ç©ºããƒãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
# =============================================================================
find_available_port() {
    local port=$1
    while lsof -i:$port >/dev/null 2>&1; do
        port=$((port + 1))
    done
    echo $port
}

# =============================================================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# =============================================================================

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
if [ ! -d "./backend" ] || [ ! -f "./frontend/package.json" ]; then
    echo "âŒ Setup required. Run 'npm run setup' first."
    exit 1
fi

echo ""
echo "ğŸš€ Omnify Tunnel Development Environment"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# é–‹ç™ºè€…åã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—
DEV_NAME=$(get_dev_name)
PROJECT_NAME=$(get_project_name)

echo "ğŸ‘¤ Developer: ${DEV_NAME}"
echo "ğŸ“ Project:   ${PROJECT_NAME}"
echo ""

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®ç©ºããƒãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
FRONTEND_PORT=$(find_available_port 3000)

# =============================================================================
# Step 1: frpcè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
# =============================================================================
echo "âš™ï¸  Generating frpc config..."
generate_frpc_config "$DEV_NAME" "$PROJECT_NAME" "$FRONTEND_PORT"
echo "   âœ… docker/frpc/frpc.toml"

# =============================================================================
# Step 2: docker-compose.ymlã‚’ã‚³ãƒ”ãƒ¼
# =============================================================================
echo "âš™ï¸  Generating docker-compose.yml..."
cp ./docker/stubs/docker-compose.yml.stub ./docker-compose.yml
echo "   âœ… docker-compose.yml"

# =============================================================================
# Step 3: Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
# =============================================================================
echo ""
echo "ğŸ³ Starting Docker services..."
docker compose up -d mysql redis phpmyadmin mailpit minio backend horizon reverb frpc

# frpcã®æ¥ç¶šã‚’å¾…ã¤
echo "â³ Waiting for tunnel connection..."
sleep 3

# =============================================================================
# Step 4: frontend .env.localã‚’æ›´æ–°
# =============================================================================
DOMAIN="${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"
API_DOMAIN="api.${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"
WS_DOMAIN="ws.${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"

cat > ./frontend/.env.local << EOF
NEXT_PUBLIC_API_URL=https://${API_DOMAIN}
NEXT_PUBLIC_REVERB_HOST=${WS_DOMAIN}
NEXT_PUBLIC_REVERB_PORT=443
NEXT_PUBLIC_REVERB_SCHEME=https
NEXT_PUBLIC_REVERB_APP_KEY=omnify-reverb-key
EOF

# =============================================================================
# æº–å‚™å®Œäº†!
# =============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Tunnel Development Environment Ready!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  ğŸŒ Frontend:    https://${DOMAIN}"
echo "  ğŸ”Œ API:         https://${API_DOMAIN}"
echo "  ğŸ“¡ WebSocket:   wss://${WS_DOMAIN}"
echo "  ğŸ“Š Horizon:     https://${API_DOMAIN}/horizon"
echo "  ğŸ—„ï¸  phpMyAdmin:  https://pma.${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"
echo "  ğŸ“§ Mailpit:     https://mail.${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"
echo "  ğŸ“¦ MinIO:       https://minio.${PROJECT_NAME}.${DEV_NAME}.dev.omnify.jp"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ–¥ï¸  Starting frontend dev server..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: æ—¢å­˜ã®Next.js devã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
pkill -f "next dev" 2>/dev/null || true
rm -f ./frontend/.next/dev/lock 2>/dev/null || true
sleep 1

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰devã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
cd frontend && npm run dev -- -p ${FRONTEND_PORT}
